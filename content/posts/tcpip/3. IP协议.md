---
title: "《TCP/IP详解卷I》3. IP协议"
date: 2019-03-07T10:22:06+08:00
slug: "3"
tags: ["网络", "读书笔记"]
---

IP 协议是 TCP/IP 协议族的核心协议。
<!--more-->

IP 提供的是不可靠、无连接的协议。

> 不可靠（unreliable）的意思是它不能保证 IP 数据报能成功地到达目的地。IP 仅提供最好的传输服务。如果发生某种错误时，如某个路由器暂时用完了缓冲区， IP 有一个简单的错误处理算法：丢弃该数据报，然后发送 ICMP 消息报给信源端。任何要求的可靠性必须由上层来提供（如 TCP）。
> 无连接（connectionless）这个术语的意思是 IP 并不维护任何关于后续数据报的状态信息。每个数据报的处理是相互独立的。这也说明， IP 数据报可以不按发送顺序接收。如果一信源向相同的信宿发送两个连续的数据报（先是 A，然后是 B），每个数据报都是独立地进行路由选择，可能选择不同的路线，因此 B 可能在 A 到达之前先到达。

## IP首部

不含选项的普通 IP 首部长度固定为 20 字节，首部格式如下：

![3-1.jpg](3-1.jpg)

> 网络中传输的字节序为大端，即先传输高字节。比如 IP 地址为 192.168.1.3，先传 192，再传 168、1、3。然而许多主机都是以小端形式存储数据的，同样的 IP 地址在主机上从低到高的存储次序为 3、1、168、192，所以传输首部之前必须先转换为网络字节序。库函数 htons(3)、htonl(3) 实现了这个功能。

- **版本字段**
目前的版本号是 4，代表 IPv4。新一代的 IP 协议是 IPv6。
- **首部长度**
指的是首部占 4 字节（32bit 字）的数目。不含选项的普通 IP 首部该字段值为 5（5 个 4 字节，总共 20 字节）。
- **TOS**
这 8bit 中，有 4bit 的 TOS 子字段，分别代表最小时延、最大吞吐量、最高可靠性和最小费用。4 bit 中只能置其中 1 bit。如果所有 4 bit 均为 0，那么就意味着是一般服务。
- **总长度字段**
指的是整个 IP 数据报的字节数。IP 数据报可能会小于以太网的最小数据长度 46 字节，如果没有总长度字段，IP 层就不知道这 46 字节中哪些是 IP 数据报，哪些是链路层填充的字节。
- **标识**、**标志**和**片偏移字段**
用于 IP 分片和重组。
- **TTL**
生存时间，每经过一个路由器，该字段值减 1。当该字段值为 0 时，数据报被丢弃，并发送 ICMP 报文通知源主机。
- **协议字段**
协议字段标识了上层协议是 TCP、UDP、ICMP 还是 IGMP
- **首部检验和**
首部检验和只计算 IP 首部的检验和，数据部分的校验由上层协议实现。> 为了计算一份数据报的 IP 检验和，首先把检验和字段置为 0。然后，对首部中每个 16 bit 进行二进制反码求和（整个首部看成是由一串 16 bit 的字组成），结果存在检验和字段中。当收到一份 IP 数据报后，同样对首部中每个 16 bit 进行二进制反码的求和。由于接收方在计算过程中包含了发送方存在首部中的检验和，因此，如果首部在传输过程中没有发生任何差错，那么接收方计算的结果应该为全 1。如果结果不是全 1（即检验和错误），那么 IP 就丢弃收到的数据报。但是不生成差错报文，由上层去发现丢失的数据报并进行重传。

- **选项字段**
选项字段是可选的，很少被使用。
在有选项字段时，选项字段都是以 4 字节对齐的，必要时填充 0 字节，保证 IP 首部始终是 4 字节的整数倍，与`首部长度`字段要求相符。

## IP路由选择

IP 路由选择的概念很简单：根据一个 IP 数据报的目的 IP 地址，IP 层决定将该报文发给谁。

### 路由表

IP 层维护着一张路由表，可以通过`route`命令查看。

```bash
$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     255.255.255.255 UG    256    0        0 eth0
192.168.10.0    192.168.1.1     255.255.255.0   UG    256    0        0 eth0
192.168.19.90   192.168.1.1     255.255.255.255 UHG   256    0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     256    0        0 lo
127.0.0.1       0.0.0.0         255.255.255.255 U     256    0        0 lo
```

每条路由表项包含以下条目：

- **目的 IP 地址（Destination）**
可以是主机地址或网络地址，由标志字段（Flags）指定。
若是主机地址，`Genmask`为`255.255.255.255`，`Flags`包含`H`，指定一台特定的主机。
若是网络地址，子网范围由`Genmask`指定，
- **网关（Gateway）**
指定下一站的 IP 地址。
如果下一站是路由器，即目的地址不在与本主机直接相连的网络上，需要通过路由器转发，则`Flags`包含`G`。
- **标志（Flags）**
U 路由表项有效。
H 目的地址是主机，而不是一个网络。
G 下一站是路由器，而不是直接相连的接口。
- **接口（Iface）**
为数据报的传输指定一个网络接口。

举个例子，以上路由表输出的第二项

```bash
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.10.0    192.168.1.1     255.255.255.0   UG    256    0        0 eth0
```

表示目的地址为`192.168.10`网段的报文，从`eth0`接口发出，下一站路由器是`192.168.1.1`。

### 关键点

- 得到目的 IP 地址后，IP 层搜寻路由表寻找匹配的条目。没有匹配条目则采用默认路由。
- 目的 IP 地址始终不变。
- 目的 MAC 地址始终为下一站的地址。

## 子网划分

### 为什么要划分子网？

A 类和 B 类地址为主机号分配了 24 位和 16 位的空间，实际上在一个网络中不会安排如此多的主机。于是在得到一个特定的网络号后，通常对主机号进一步进行划分，分配一定的比特作为子网号，剩下的才用作主机号。

### 子网掩码

主机知道自己的 IP 地址，同时还需要知道自己所在的子网。子网掩码确定了一个 IP 地址中多少比特用于子网号，多少比特用于主机号。

![3-7.jpg](3-7.jpg)

如上图，子网掩码`255.255.255.0`表示前 24 位为网络号和子网号，子网掩码`255.255.192.0`表示前 26 位为网络号和子网号。假设主机地址是`140.252.1.100`，则可以表示为`140.252.1.100/24`和`140.252.1.100/26`。

---

## References

1. 《TCP/IP 详解卷 1：协议》

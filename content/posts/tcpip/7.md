---
date: 2019-03-12 21:26:00
title: 《TCP-IP详解卷1》7. Traceroute程序
tags:
- 网络
- 读书笔记
---

Traceroute程序用于跟踪路由。虽然之前提到的IP记录路由选项（RR）也能跟踪路由，但这个选项有一些限制，其中最主要的原因就是IP首部长度有限，最多只能存放9个IP地址，在现在的互联网上是远远不够的。而Traceroute程序没有这些限制，对目的端来说，它只是一个UDP包。

<!--more-->

# 原理

## TTL字段

TTL字段是IP首部的字段。每经过一个路由器，TTL字段-1。TTL字段为0时，丢弃该数据报，并向源端发送一份超时ICMP报文。

## 操作过程

向目标主机发送TTL为1的IP数据报，第一个路由器收到该数据报将TTL减1，丢弃该数据报，并回发一份ICMP超时报文。Traceroute程序收到该ICMP报文得到第一个路由器的地址。

再向目标主机发送TTL为2的IP数据报，得到第二个路由器的地址，以此类推。

## 如何判断是否到达目标主机

目标主机收到TTL=1的数据报时，该数据报已经到达目的地，所以目标主机不会发送超时ICMP报文。

判断方法是，将数据报的（UDP）目的端口设为一个不可能的值（大于30000），当数据报到达时，目标主机将回发一份“端口不可达”的ICMP报文。

这样就可以通过区分接收到的ICMP报文是“超时”还是“端口不可达”来判断到达路由器还是目标主机，从而判断什么时候结束。

**注意**：

- 返回的ICMP报文中的源IP地址是路由器的入口地址。

# ICMP超时报文

traceroute程序预期路由器返回ICMP超时报文，而目的主机返回ICMP端口不可达报文。

ICMP端口不可达报文已经介绍过了，这里只介绍一下ICMP超时报文。

![8-2.jpg](8-2.jpg)

- **类型**：11

- **代码**

  有2种ICMP超时报文。代码字段为`0`表示TTL值为0，Traceroute程序利用的正是这种ICMP差错报文。代码字段为`1`表示IP分片组装时的“组装报文超时”。

# 一个例子

windows上的Tracert程序与Traceroute程序有相同的功能。

# IP源站选路选项

------

# References

1. 《TCP/IP详解卷1：协议》

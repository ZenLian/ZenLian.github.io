---
title: "《TCP/IP详解卷I》10. TCP"
date: 2019-03-17T10:44:55+08:00
slug: "10"
tags: ["网络", "读书笔记"]
toc: true
---

TCP 是运输层协议，网络层基于 IP 协议，为应用层提供面向连接、可靠的字节流服务。
<!--more-->

## TCP 首部

TCP 数据被封装在 IP 数据包中：
![image.png](1.png)
不包含选项的 TCP 首部为 20 字节：
![image.png](2.png)

- 源端口和目的端口：用于标识一个 TCP 连接的两端。TCP 服务器可以与多个客户端建立连接，每个连接的本地端口号都相同，内核协议栈通过对方 IP、端口号的不同区分不同的连接。
- 序号和确认序号：TCP 是可靠协议，发出的数据报需要收到对方的确认才能认为数据报已送达。
- 标识位：6 个标识位分别被设为 1 时有不同的作用
  - URG：紧急指针有效
  - ACK：确认序号有效
  - PSH：接收方应尽快将这个报文段交给应用层
  - RST：重置连接
  - SYN：同步序号，用于建立一个连接
  - FIN：发送端关闭
- 窗口大小：用于 TCP 的流量控制。声明了接收端当前可接收的字节数，发送端不能发送超过该字节数大小的数据。

## TCP 连接的建立与终止

![image.png](3.png)

### 3 次握手建立连接

TCP 建立连接需要 3 次握手：

1. 客户端发送一个 SYN，带有初始序号（1415531521)；
1. 服务器发回一个 ACK + SYN（ACK 和 SYN 位同时置 1）。ACK 是对客户端 SYN 的确认，确认序号为客户端发出的初始序号 + 1 （1415531522）。SYN 是向客户端发送的建立连接请求，也带有服务端的初始序号（1823083521）；
1. 客户端回应一个 ACK。确认序号为服务端发出的初始序号 + 1（1823083522）。

一端发出 SYN 后会启动定时器，若定时器到期后还未收到 ACK，则会重传前一个 SYN。第一个定时器约 6s，第二个约 24s，若几次尝试都无回应，则放弃连接。

### 4 次挥手断开连接

TCP 断开连接需要 4 次挥手：

1. 客户端发送 FIN，序号为 x；
1. 服务端发回 ACK，确认序号为 x + 1；此时 TCP 处于**半关闭**状态，客户端已经不能向服务端发送数据，但仍然能接受服务端的数据。
1. 服务端发送 FIN，序号为 y；
1. 客户端发回 ACK，确认序号为 y + 1；此时 TCP 连接完全关闭。

### TCP 的半关闭

![image.png](4.png)

TCP 连接的一端发出 FIN 报文，只是表示结束本端的发送，但仍然可以接收对端发送的数据。关闭一个 TCP socket 时调用 shutdown （而不是 close）可以执行 TCP 半关闭。

### TCP 的状态迁移图

![image.png](5.png)
![image.png](6.png)

#### TIME_WAIT 状态

如上图的 *TIME_WAIT* 状态也称为 *2MSL* 等待状态，客户必须在 *TIME_WAIT* 状态停留 *2MSL* 的时间再关闭连接，是为了防止 *FIN* N 的确认 *ACK* N+1 丢失。
如果客户发完 *ACK N+1* 后就关闭连接，那么这个 *ACK N+1* 一旦丢失，服务器重传 *FIN N*，客户就不能在正常的连接上收到重传的 *FIN N*。
*2MSL* 等待状态会使得一个已经在应用程序中已经关闭的 TCP socket 端口（IP 地址和端口对）在 2MSL 时间内不能被重新使用。socket 应用程序可以通过设置 SO_REUSEADDR 强制重新监听处于 2MSL 等待状态的 IP/端口对，

- **MSL（Maximum Segment Lifetime）**：报文段最大生存时间，即任何报文段被丢弃前在网络内的最长时间。实现中的常用值为 30s，1 分钟或 2 分钟。

### RST 报文段

TCP 使用复位报文段（RST 位置 1）指示错误。

- **到不存在的端口的连接请求**

当 TCP 连接请求到达时，若没有进程在监听目的端口，内核将回应一个 RST 报文。
这和 UDP 不同，UDP 使用的是 ICMP 端口不可达报文。

- **异常终止连接**

正常关闭连接是发送 FIN，进行四次挥手；发送 RST 则表示异常终止连接，另一端不对 RST 报文进行确认，本端也不等待回应。对一个收到 RST 后的 TCP socket 调用 read，会返回 `Connection reset by peer` 错误。

### 同时打开和同时关闭

- **同时打开：** TCP 允许同时打开，但平时几乎不可能遇到。
![image.png](18-17.png)

- **同时关闭：**
![image.png](18-19.png)

### TCP 选项

TCP 选项跟在 20 字节 TCP 首部后，一个 TCP 报文段可以同时携带多个首部。最常见的是 SYN 报文段中携带的 MSS（最大报文段长度）选项。
![image.png](18-20.png)

#### MSS（最大报文段长度）选项

MSS 表示单个 TCP 数据报数据部分的最大长度。建立 TCP 连接时，连接的双方在 SYN 报文段中附带 MSS 选项告知对方各自的 MSS。在不发生分段的前提下，MSS 一般越大越好，在同一个以太网中可达 1460 （加上 20 字节 TCP 首部和 20 字节 IP 首部，刚好是以太网的 MTU = 1500 字节）。

## TCP 的交互数据流

TCP 有两种数据流：

1. ..交互数据流..。指的是用于交互性应用的小报文段，如 telnet 协议，客户端每键入一个字符就发送一个 TCP 报文段。
2. ..成块数据流..。指的是用户数据交换的填满 MSS 的大报文段，如 http 协议，每个报文段长度都尽可能填满 MSS。

交互数据流中每个交互按键都会产生一个数据分组，容易增加网络负载。TCP 协议用于减小交互数据流的网络负载的方法有：

1. **经受时延的确认**。TCP 收到数据时不立即发送确认，而是等待一段时间（一般为 200ms），将 ACK 与该方向的数据一同发送。也称为**数据捎带 ACK**。
2. **Nagle 算法**。对于一个 TCP 连接的发送方，最多只能有一个未被确认的小分组。TCP 在收到前一个小分组的 ACK 之前，不会发送应用层要求发送的数据，而是将这些数据堆积为一个分组，在前一个小分组的 ACK 到来之后一起发送。在局域网中，Nagle 算法会产生交互性时延，socket 接口可以通过 `TCP_NODELAY` 选项关闭 Nagle 算法。

## TCP 的成块数据流

TCP 的成块数据流采用..滑动窗口协议..控制流量，不用每发送一个报文段就等待确认，而是连续发送多个分组直到填满接收方的接收窗口，而接收方只需要确认最后一个分组就表示前面的分组都已经收到。因此可以加速成块数据的传输。

### 滑动窗口

滑动窗口实际上就是接收方的 TCP 缓存大小。也就是发送方根据接收方的缓存决定自己最多能连续发送多少数据。如果接收窗口为 0，发送方停止发送。
TCP 的每个报文段中都会通报自己的接收窗口大小。发送方可以连续发送不超过接收方窗口大小的数据。

- 接收方的确认序号决定了窗口的左边沿（向右移动）
- 接收方通告的窗口大小决定了窗口大小。窗口右边沿不能向左移动。
- 窗口大小可以变小（左边沿向右移动，右边沿不动），说明接收方的内核协议栈已经接收了，但应用层还未取走。

![image.png](20-1.png)
![image.png](20-4.png)
![image.png](20-6.png)

### 拥塞窗口（慢启动）

**解决的问题：**

- 如果在接收方和发送方之间存在低速链路，直接发送通告窗口大小的数据会造成阻塞。
- 通告窗口是接收方使用的流量控制，而拥塞窗口是发送方使用的流量控制。

**如何解决：**

- 发送方始终取拥塞窗口和通告窗口中的较小值作为发送上限
- 拥塞窗口初始化为 1 个报文段，即发送方发送 1 个报文段就等待确认；
- 收到确认后，将拥塞窗口加倍，发送 2 个报文段并等待确认；
- 直到接收超时，发送方就能确定当前的拥塞窗口大小，之后都用这个窗口发送数据。

**现象：**

- **慢启动**。比如在下载的时候，速度都是慢慢起来的。

## TCP 的超时与重传

TCP 的每个连接有 4 个定时器：

- 重传定时器
- 坚持定时器
- 保活定时器
- 2MSL 定时器

### 重传定时器基本原理

- 发送方发送一个数据报后开启定时器，如果定时器时间内未收到确认，则重传数据。

### 指数退避

指数退避指的是超时发生后，每次重传定时器的时间设置程指数增长关系。如书中的例子，第 1 次重传在 1s 后，第 2 次在 3s 后，之后分别在 6、12、24、48 和多个 64s，直到发送 RST 放弃连接。

### 往返时间测量

- RTT：往返时间。
- RTO：重传超时时间。

由于网络的不确定性，TCP 连接的 RTT 是实时变化的。TCP 必须实时估计当前连接的 RTT，并根据 RTT 的值才能正确设置 RTO。
基本方法是测量一个数据报和它的确认到达的时间差，并用特定的算法计算 RTT，再计算 RTO。公式太多就不列了。

### 拥塞避免算法

拥塞避免和慢启动是独立的算法，但常常在一起实现。
拥塞避免算法和慢启动算法维护两个变量：拥塞窗口 cwnd 和慢启动门限 ssthred。所谓慢启动门限，就是当拥塞窗口超过该门限时，就使用拥塞避免算法，否则就使用慢启动算法。

**算法概要：**

1. 对一个给定的连接，初始化cwnd为1个报文段，ssthresh为65535个字节。
2. TCP输出例程的输出不能超过cwnd和接收方通告窗口的大小。拥塞避免是发送方使用 的流量控制，而通告窗口则是接收方进行的流量控制。前者是发送方感受到的网络拥塞的估 计，而后者则与接收方在该连接上的可用缓存大小有关。
3. 当拥塞发生时（超时或收到重复确认），ssthresh被设置为当前窗口大小的一半（cwnd 和接收方通告窗口大小的最小值，但最少为2个报文段）。此外，如果是超时引起了拥塞，则 cwnd被设置为1个报文段（这就是慢启动）。
4. 新的数据被对方确认时，就增加cwnd，但增加的方法依赖于我们是否正在进行慢启动或拥塞避免。如果cwnd小于或等于ssthresh，则正在进行慢启动，否则正在进行拥塞避免。 慢启动一直持续到我们回到当拥塞发生时所处位置的半时候才停止（因为我们记录了在步骤2 中给我们制造麻烦的窗口大小的一半），然后转为执行拥塞避免。
5. 慢启动算法每次将 cwnd 翻倍，而拥塞避免算法每次将 cwnd 加 1。

![image.png](21-8.png)

### 快速重传与快速恢复算法

- 快速重传：丢失了中间的分组时，在重传定时器溢出之前就启动重传；
- 快速恢复：不使用慢启动，直接使用拥塞避免，使传输速率快速恢复。

**TCP 失序**：

在认识快速重传与快速恢复算法之前，首先要知道 TCP 是怎么处理失序问题的。

假设发送方连续发送了 3 个报文段。接收方首先收到报文段 1，发送 1 的确认；接着收到报文段 3，这时该怎么办？显然接收方不能发送报文段 3 的确认，因为报文段 2 还没收到。此时接收方会重复发送报文段 1 的确认，以告诉发送方失序了。

报文段 2 有可能会到达（仅仅是失序），也有可能不会到达（丢失了）。如果发送方收到 3 个及以上重复的 ACK，那么报文段 2 极有可能是丢失了，此时就需要重传报文段 2，而不必等待定时器溢出，这就是**快速重传算法**。

因为这时收发两端仍然有数据流动，我们不想执行慢启动来突然减少数据流，接下来直接执行的是拥塞避免算法，所以叫做**快速恢复算法**。

**算法概要：**

1. 当收到第3个重复的 ACK 时，将 ssthresh 设置为当前拥塞窗口 cwnd 的一半。重传丢失的报文段。设置 cwnd 为 ssthresh 加上3倍的报文段大小。
1. 每次收到另一个重复的ACK时， cwnd 增加1个报文段大小并发送1个分组（如果新的cwnd 允许发送）
1. 当下一个确认新数据的ACK到达时，设置cwnd 为 ssthresh （在第1步中设置的值）。这个ACK应该是在进行重传后的一个往返时间内对步骤1中重传的确认。另外，这个 ACK 也应该是对丢失的分组和收到的第1个重复的 ACK 之间的所有中间报文段的确认。这一步采用的是拥塞避免，因为当分组丢失时我们将当前的速率减半。

## 坚持定时器

**解决的问题**：

- 发送方在通告窗口为 0 时停止发送，等待非 0 的窗口
- 接收方发送 ACK 通告一个非 0 窗口，但此 ACK 丢失了
- 由于 ACK 不会确认与重传，造成发送方和接收方同时等待对方的死锁情况

**解决方法**：

- 通告窗口为 0 时，发送方启动**坚持定时器**周期性地向接收方查询窗口大小
- 定时器周期使用 1、2、4、8、16、32、 的普通指数退避
- TCP 从不放弃探查窗口，直到窗口被打开或连接终止

### 糊涂窗口综合征

**什么是糊涂窗口综合征：**

- 接收方通告一个小的非 0 窗口，发送方马上发送小报文段填满该窗口。造成网络上充满小报文段，影响网络利用率。

**建议：**

1. 接收方不通告小窗口。通常的算法是接收方不通告一个比当前窗口大的窗口（可以为0），除非窗口可以增加一个报文段大小（也就是将要接收的MSS）或者可以增加接收方缓存空间的一半，不论实际有多少。
1. 发送方避免出现糊涂窗口综合症的措施是只有以下条件之一满足时才发送数据：
   1. 可以发送一个满长度的报文段；
   1. 可以发送至少是接收方通告窗口大小一半的报文段；
   1. 可以发送任何数据并且不希望接收ACK（也就是说，我们没有还未被确认的数据）或者该连接上不能使用Nagle算法。

## 保活定时器

保活定时器在无数据传输的情况下，定时探查 TCP 连接的对方是否保持正常。如果收到 RST 或对方无响应，则关闭连接。

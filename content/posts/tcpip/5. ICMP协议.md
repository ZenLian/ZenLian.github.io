---
title: "《TCP/IP详解卷I》5. ICMP协议"
date: 2019-03-09T09:22:23+08:00
slug: "5"
tags: ["网络", "读书笔记"]
---

因特网控制报文协议（ICMP，Internet Control Message Protocol）用于传递差错报文等控制信息。
<!--more-->

## ICMP报文格式

ICMP 封装在 IP 数据报内部，报文格式如下：

- **类型**和**代码**字段：ICMP 报文有 15 种不同类型，同一类型通过代码字段细分。
- **检验和**：该字段是必须的，覆盖整个 ICMP 报文，算法与 IP 首部检验和相同。

## ICMP 报文类型

不同类型的 ICMP 报文由**类型**和**代码**字段唯一标识，如下图：

![6-2.jpg](6-2.jpg)

上图最后两列又把 ICMP 报文分为**查询报文**和**差错报文**，对这两种报文的处理方式不同。
这里只介绍一下 2 个 ICMP 查询报文（地址掩码请求与应答、时间戳请求与应答）和 1 个 ICMP 差错报文（ICMP 不可达差错），一些其他的 ICMP 报文在后续章节会陆续介绍。

### ICMP 查询报文

#### 地址掩码请求与应答

用于查询子网掩码。请求报文一般发往广播地址，而应答则是单播的。

![6-3.jpg](6-3.jpg)

- **标识符**和**序列号**
由发送端任意设定，应答报文中返回原值。这样发送方就可以把应答与请求进行匹配。
- **子网掩码**
应答报文返回自己的子网掩码。

#### 时间戳请求与应答

用于查询另一个系统的当前时间。

![6-4.jpg](6-4.jpg)

- **发起时间戳**
由请求端填写。标准时间戳一般是自午夜起计算的毫秒数，UTC 时间。
- **接收时间戳**和**传送时间戳**
由应答端填写。应答端收到请求报文时填写接收时间戳，发送应答时填写传送时间戳。实际上这两个字段一般设成相同值。

请求端可根据应答报文调整时间。

![6-7.jpg](6-7.jpg)

1. **计算往返时间（RTT）**。RTT = 收到应答时的时间 - 发送请求的时间。
2. **调整本机时间**。假设 RTT 一半用于请求报文的传输，一半用于应答报文的传输，那么 本机时间调整值 = 接收时间戳 - 发送时间戳 - RTT/2。

另外，当系统返回一个非标准时间戳时（不是自午夜起计算的毫秒数，UTC 时间），它将 32bit 时间戳的高位置 1。此时不能计算时间差，因为单位不一致。

其他获取时间日期的方法：

- **daytime 服务**（RFC 867）。返回自 1900 年 1 月 1 日起计算的秒数，UTC。
- **网络时间协议（NTP）**（RFC 1305）。精确调整一组系统的时钟，误差在毫秒级以内。
- **分布式时间服务（DTS）**。
- **守护程序 timed(8)**。同步局域网内系统时钟，不在广域网内工作。

### ICMP 差错报文

ICMP 差错报文始终包含产生该差错的 IP 数据报的首部和数据的前 8 字节，这样接受 ICMP 差错报文的模块就能把该差错对应到特定协议（IP 首部的协议字段）和特定进程（IP 数据的前 8 字节包含 TCP/UDP 端口号）。

以下情况不会产生 ICMP 差错报文：

1. ICMP 差错报文
2. 目的 IP 地址是广播地址或多播地址
3. 目的链路层地址是广播地址
4. 不是 IP 分片的第一片
5. 源地址为零地址、环回地址、广播地址或多播地址（这些地址本就不该作为源地址出现在网络上）

#### ICMP 不可达差错

ICMP 不可达差错报文的一般格式如下：

![6-10.jpg](6-10.jpg)

- 第 2 个 32bit 必须为 0。但是当**代码**字段为 4 时（“需要分片但设置了不分片比特”），路径 MTU 发现机制允许路由器把外出接口的 MTU 填入低 16bit。
- ICMP 规则允许返回多于 8 个字节的原差错 IP 数据报中的数据。但是大多数从伯克利派生出的系统只返回 8 字节。

## ICMP 报文的处理

不同系统对 ICMP 报文的处理方式不同，下面给出 4.4BSD 系统对每个可能的 ICMP 报文的处理方法：

![6-12.jpg](6-12.jpg)

---

## References

1. 《TCP/IP 详解卷 1：协议》

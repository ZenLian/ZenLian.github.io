---
title: "《TCP/IP详解卷I》6. Ping程序"
date: 2019-03-10T09:26:43+08:00
tags: ["网络", "读书笔记"]
---

我们经常用 Ping 程序来测试两台主机是否通过网络连通。Ping 程序实际上是向目的主机发送了一份 ICMP 回显请求，并等待 ICMP 回显应答。

我们称发送 ICMP 回显请求的 ping 程序为客户，而称被 ping 的主机为服务器。ping**服务器**的功能是直接在**内核**TCP/IP 协议栈中实现的。
<!--more-->

## 报文格式

ping 程序发送的 ICMP 回显请求和返回的 ICMP 回显应答报文格式如下。

![7-1.jpg](7-1.jpg)

- **标识符**
Unix 系统实现将该字段置为发送进程的 ID 号。这样即使在同一台主机上同时运行了多个 ping 程序实例，ping 程序也可以识别出返回的信息。
- **序列号**
序列号从 0 开始，每发送一次新的回显请求就加 1。
- **选项数据**

## ping 程序输出

ping 一下学校论坛，输出如下：

```bash
$ ping www.cc98.org
PING www.cc98.org (10.10.98.98) 56(84) bytes of data.
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=1 ttl=123 time=0.932 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=2 ttl=123 time=1.06 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=3 ttl=123 time=5.71 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=4 ttl=123 time=1.15 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=5 ttl=123 time=1.06 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=6 ttl=123 time=1.24 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=7 ttl=123 time=1.19 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=8 ttl=123 time=1.20 ms
^C
--- www.cc98.org ping statistics ---
8 packets transmitted, 8 received, 0% packet loss, time 7006ms
rtt min/avg/max/mdev = 0.932/1.697/5.715/1.522 ms
```

Ping 程序每隔 1 秒发送一个 ICMP 回显请求，并在收到应答后计算往返时间（RTT）。

linux 系统下 Ping 程序会不断发送回显请求，直到键入`Ctrl-C`中断。而 Window 系统下只会发送 4 个回显请求，并且在收到上一个应答或超时后才会发送下一个请求。

一般来说第一个 RTT 会比其他的大。这是因为发送第一个 ICMP 回显请求之前需要将域名转换为 IP 地址（域名不在本地缓存中时）、通过 ARP 获取硬件地址（目的端硬件地址不在 ARP 高速缓存中时）。

## IP记录路由选项

Ping 程序可以设置 IP 记录路由（RR）选项，以提供记录路由的功能。linux 下是`-R`选项。

### 工作流程

1. ping 程序在发送的 ICMP 回显请求报文中设置 IP 头部的 RR 选项
2. 每个处理该报文的路由器都将它的 IP 地址放入选项字段中
3. 当报文到达目的端时，IP 清单地址被复制到 ICMP 回显应答中
4. 返回途中所经过的路由器 IP 地址被加入回显报文的 IP 头部选项字段
4. ping 程序收到回显应答，打印出往返的 IP 地址清单

### 缺陷

1. 中间路由器不一定支持 RR 选项
2. Ping 服务器不一定支持将 ICMP 回显请求中的 RR 清单复制到 ICMP 回显应答中
2. IP 首部最多存放 9 个 IP 地址。IP 首部长度字段只有 4bit，因此整个 IP 首部最长只有 15 个 32bit 字（即 60 字节），减去 IP 首部固定长度 20 字节，RR 选项首部 3 字节，只剩下 37 字节来存放 IP 地址清单，最多只能存放 9 个 IP 地址。

### IP 记录路由选项格式

IP 头部中 RR 选项的一般格式如下：

![7-3.jpg](7-3.jpg)

- **code**
指明 IP 选项类型。对于 RR 选项该字段为`7`。
- **len**
选项总长度，受 IP 首部长度限制，最大为`40`。对于 RR 选项记录最多 9 个 IP 地址时，该字段为`39`。
- **ptr**
指针字段，从 1 开始计数，指向存放下一个 IP 地址的位置。初始值为 4，每存入 1 个 IP 地址，ptr 的值加 4。ptr=40 表示清单已满。

> **注意**，RFC 791 指定路由器 RR 选项中记录的 IP 地址为**出口 IP 地址**。

我在内网测试了一下`ping -R`选项，发出的 ICMP 回显请求报文中确实带了 RR 选项，但返回的 ICMP 回显应答中没有 RR 的任何信息。说明目的主机不支持该选项。

## IP时间戳选项

IP 时间戳选项要求路由器将收到数据报的时间戳填入 IP 头部。这个选项用处不大，但还是抄书列一下。

IP 时间戳选项格式如下：

![7-7.jpg](7-7.jpg)

- **code**
时间戳选项代码为`0x44`。
- **len**
选项总长度，一般为`36`或`40`。
- **ptr**
与 IP 记录路由选项的`ptr`字段相同，指向下一个可用空间在指针。
- **OF**
溢出字段，4bit 的值。如果路由器因为没有空间而不能增加时间戳选项，那么它将增加溢出字段。
- **FL**
4bit 的值，表示标志字段。含义如下：
![7-8.jpg](7-8.jpg)

- **时间戳**
时间戳的取值与 ICMP 时间戳请求与应答相同，即 UTC 时间从午夜开始计算的毫秒数。同样的，打开时间戳高位表示时间戳为非标准值。

---

## References

1. 《TCP/IP 详解卷 1：协议》

---
date: 2019-03-07 21:26:00
title: 《TCP-IP详解卷1》学习笔记(3)-IP协议
permalink: tcp-ip-volumn1-3
categories:
- 计算机
- 《TCP-IP详解卷1》
tags:
- 网络
- 读书笔记
---

IP协议是TCP/IP协议族的核心协议。

<!--more-->

IP提供的是不可靠、无连接的协议。

> 不可靠（unreliable）的意思是它不能保证IP数据报能成功地到达目的地。IP仅提供最好的传输服务。如果发生某种错误时，如某个路由器暂时用完了缓冲区， IP有一个简单的错误处理算法：丢弃该数据报，然后发送ICMP消息报给信源端。任何要求的可靠性必须由上层来提供（如TCP）。
>
> 无连接（connectionless）这个术语的意思是IP并不维护任何关于后续数据报的状态信息。每个数据报的处理是相互独立的。这也说明， IP数据报可以不按发送顺序接收。如果一信源向相同的信宿发送两个连续的数据报（先是A，然后是B），每个数据报都是独立地进行路由选择，可能选择不同的路线，因此B可能在A到达之前先到达。

# IP首部

不含选项的普通IP首部长度固定为20字节，首部格式如下：

{% asset_img 3-1.jpg %}

> 网络中传输的字节序为大端，即先传输高字节。比如IP地址为192.168.1.3，先传192，再传168、1、3。然而许多主机都是以小端形式存储数据的，同样的IP地址在主机上从低到高的存储次序为3、1、168、192，所以传输首部之前必须先转换为网络字节序。库函数htons(3)、htonl(3)实现了这个功能。

## 版本字段

目前的版本号是4，代表IPv4。新一代的IP协议是IPv6。

## 首部长度

指的是首部占4字节（32bit字）的数目。不含选项的普通IP首部该字段值为5（5个4字节，总共20字节）。

## TOS

这8bit中，有4bit的TOS子字段，分别代表最小时延、最大吞吐量、最高可靠性和最小费用。4 bit中只能置其中1 bit。如果所有4 bit均为0，那么就意味着是一般服务。

## 总长度字段

指的是整个IP数据报的字节数。IP数据报可能会小于以太网的最小数据长度46字节，如果没有总长度字段，IP层就不知道这46字节中哪些是IP数据报，哪些是链路层填充的字节。

## 标识、标志和片偏移字段

用于IP分片和重组。

## TTL

生存时间，每经过一个路由器，该字段值减1。当该字段值为0时，数据报被丢弃，并发送ICMP报文通知源主机。

## 协议字段

协议字段标识了上层协议是TCP、UDP、ICMP还是IGMP

## 首部检验和

首部检验和只计算IP首部的检验和，数据部分的校验由上层协议实现。

> 为了计算一份数据报的IP检验和，首先把检验和字段置为0。然后，对首部中每个16 bit进行二进制反码求和（整个首部看成是由一串16 bit的字组成），结果存在检验和字段中。当收到一份IP数据报后，同样对首部中每个16 bit进行二进制反码的求和。由于接收方在计算过程中包含了发送方存在首部中的检验和，因此，如果首部在传输过程中没有发生任何差错，那么接收方计算的结果应该为全1。如果结果不是全1（即检验和错误），那么IP就丢弃收到的数据报。但是不生成差错报文，由上层去发现丢失的数据报并进行重传。

## 选项字段

选项字段是可选的，很少被使用。

在有选项字段时，选项字段都是以4字节对齐的，必要时填充0字节，保证IP首部始终是4字节的整数倍，与`首部长度`字段要求相符。



# IP路由选择

## 路由表

IP层维护着一张路由表，==BOOKMARK HERE==

------

# References

1. 《TCP/IP详解卷1：协议》

<!--印地安老斑鸠-周杰伦-->
{% meting "002GQJAQ3w9yuh" "tencent" "song" "autoplay" "fixed" "volume: 0.3" "lrctype:0" %}


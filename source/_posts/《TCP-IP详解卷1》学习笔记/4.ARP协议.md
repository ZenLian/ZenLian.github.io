---
date: 2019-03-08 22:13:03
title: 《TCP-IP详解卷1》学习笔记(4)-ARP协议
permalink: tcp-ip-volumn1-4
categories:
- 计算机
- 《TCP-IP详解卷1》
tags:
- 网络
- 读书笔记
---

数据链路层有自己的寻址机制，以太网是根据48bit的以太网地址来确定目的接口的，而不关心IP地址。
地址解析协议为IP地址和数据链路层的硬件地址提供映射，ARP将IP地址转为硬件地址，RAPR则将硬件地址转为IP地址。

<!--more-->

# 流程

假设链路层是以太网。

1. 发送一个数据包时，IP数据报从IP层传给链路层。
2. 链路层需要填充以太网头部。源地址和协议类型都很容易填入，剩下目的地址，与路由表中的下一站地址相对应。
3. 首先查找本地ARP缓存，看是否有与下一站IP地址对应的硬件地址。若找到，则填入，发送数据报。
4. 若本地ARP缓存中找不到，则广播ARP请求报文，请求拥有该IP地址的主机回应其硬件地址。
5. 收到ARP回应报文，将报文中回应的硬件地址填入以太网头部。
6. 发送IP数据报。

# ARP分组格式

ARP请求和应答封装在以太网帧中，分组格式如下：

{% asset_img 4-3.jpg %}

- **以太网目的地址**

  一般来说ARP请求是广播的，以太网目的地址全为1；而ARP应答是单播的。

- **帧类型**

  `0x0806`表示ARP。

- **硬件类型**

  `1`表示以太网。

- **协议类型**

  `0x0800`表示IP地址。它的值以太网头部表示IP数据报的类型字段相同，这是有意设计的。

- **硬件地址长度**和**协议地址长度**

  以字节为单位，`6`和`4`分别对应以太网硬件地址长度和IP地址长度。

- **操作类型(op)**

  1	ARP请求

  2	ARP应答

  3	RARP请求

  4	RARP应答

- **发送端以太网地址**、**发送端IP地址**、**目的以太网地址**、**目的IP地址**

  这里有些信息与以太网头部是重复的。

  对于一个ARP请求，除**目的以太网地址**外其他字段都有填充值。

  系统收到给自己的ARP请求后，填入自己的硬件地址，然后互换两个目的地址和发送端地址，并把`op`字段置2发出一个ARP回应。

# ARP缓存

每台主机上都拥有一个ARP高速缓存，存放最近的IP地址到硬件地址的映射。发送一个IP数据报时，首先在本地ARP缓存中查找目的IP地址对应的硬件地址，不必每次都发送ARP请求报文，从而提高了效率。高速缓存的生存时间一般为20分钟。

我们可以用`arp(8)`命令查看ARP高速缓存。`-e`显示所有ARP缓存(linux格式)，`-n`显示IP地址而不是域名。

```shell
$ arp -en
Address                  HWtype  HWaddress           Flags Mask            Iface
192.168.233.1            ether   00:50:56:c0:00:08   C                     ens33
192.168.233.2            ether   00:50:56:ea:30:ed   C                     ens33
```

ARP缓存更新的情况：

- 收到ARP请求。ARP请求是广播的，同一网络内任何主机都会收到，从而可根据ARP请求中的发送端IP和MAC地址更新ARP缓存。
- 收到ARP回应。ARP回应是单播的，只能收到给自己的ARP回应。根据ARP回应中的发送端IP和MAC地址更新ARP缓存。

# ARP代理

一个网络中的路由器可以代替该网络中的主机发送ARP应答，让外部网络的ARP请求发起者认为路由器就是目的主机，而将分组发送给路由器，再由路由器转发给目的主机。

ARP欺骗也是利用同样的原理，中间主机对所有ARP请求报文进行回复，让所有源主机都将分组发送到中间主机上，以窃取数据。

# 免费ARP

免费ARP指的是系统启动期间，发送ARP查找自己IP地址对应的硬件地址。

## 作用

1. **确认自己的IP地址是否被占用。**如果主机收到了免费ARP请求的回应，说明同一网络上有相同IP地址的其他主机，提醒系统IP配置有误。
2. **更新其他主机的ARP缓存。**其他主机收到该免费ARP请求后，可以根据请求中的发送端IP和MAC地址更新ARP缓存。

------

# References

1. 《TCP/IP详解卷1：协议》

<!--开始懂了-孙燕姿-->
{% meting "003PSWcB4EDl6P" "tencent" "song" "autoplay" "fixed" "volume: 0.3" "lrctype:0" %}


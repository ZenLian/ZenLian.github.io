---
date: 2019-03-10 23:01:13
title: 《TCP-IP详解卷1》学习笔记(6)-Ping程序
permalink: tcp-ip-volumn1-6
categories:
- 计算机
- 《TCP-IP详解卷1》
tags:
- 网络
- 读书笔记
---

我们经常用Ping程序来测试两台主机是否通过网络连通。Ping程序实际上是向目的主机发送了一份ICMP回显请求，并等待ICMP回显应答。

我们称发送ICMP回显请求的ping程序为客户，而称被ping的主机为服务器。ping**服务器**的功能是直接在**内核**TCP/IP协议栈中实现的。

<!--more-->

# 报文格式

ping程序发送的ICMP回显请求和返回的ICMP回显应答报文格式如下。

{%asset_img 7-1.jpg %}

- **标识符**

  Unix系统实现将该字段置为发送进程的ID号。这样即使在同一台主机上同时运行了多个ping程序实例，ping程序也可以识别出返回的信息。

- **序列号**

  序列号从0开始，每发送一次新的回显请求就加1。

- **选项数据**

# Ping程序输出

ping一下学校论坛，输出如下：

```shell
$ ping www.cc98.org
PING www.cc98.org (10.10.98.98) 56(84) bytes of data.
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=1 ttl=123 time=0.932 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=2 ttl=123 time=1.06 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=3 ttl=123 time=5.71 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=4 ttl=123 time=1.15 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=5 ttl=123 time=1.06 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=6 ttl=123 time=1.24 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=7 ttl=123 time=1.19 ms
64 bytes from 10.10.98.98 (10.10.98.98): icmp_seq=8 ttl=123 time=1.20 ms
^C
--- www.cc98.org ping statistics ---
8 packets transmitted, 8 received, 0% packet loss, time 7006ms
rtt min/avg/max/mdev = 0.932/1.697/5.715/1.522 ms
```

Ping程序每隔1秒发送一个ICMP回显请求，并在收到应答后计算往返时间（RTT）。

linux系统下Ping程序会不断发送回显请求，直到键入`Ctrl-C`中断。而Window系统下只会发送4个回显请求，并且在收到上一个应答或超时后才会发送下一个请求。

一般来说第一个RTT会比其他的大。这是因为发送第一个ICMP回显请求之前需要将域名转换为IP地址（域名不在本地缓存中时）、通过ARP获取硬件地址（目的端硬件地址不在ARP高速缓存中时）。

# IP记录路由选项

Ping程序可以设置IP记录路由（RR）选项，以提供记录路由的功能。linux下是`-R`选项。

## 工作流程

1. ping程序在发送的ICMP回显请求报文中设置IP头部的RR选项
2. 每个处理该报文的路由器都将它的IP地址放入选项字段中
3. 当报文到达目的端时，IP清单地址被复制到ICMP回显应答中
4. 返回途中所经过的路由器IP地址被加入回显报文的IP头部选项字段
5. ping程序收到回显应答，打印出往返的IP地址清单

## 缺陷

1. 中间路由器不一定支持RR选项
2. Ping服务器不一定支持将ICMP回显请求中的RR清单复制到ICMP回显应答中
3. IP首部最多存放9个IP地址。IP首部长度字段只有4bit，因此整个IP首部最长只有15个32bit字（即60字节），减去IP首部固定长度20字节，RR选项首部3字节，只剩下37字节来存放IP地址清单，最多只能存放9个IP地址。

## IP记录路由选项格式

IP头部中RR选项的一般格式如下：

{%asset_img 7-3.jpg %}

- **code**

  指明IP选项类型。对于RR选项该字段为`7`。

- **len**

  选项总长度，受IP首部长度限制，最大为`40`。对于RR选项记录最多9个IP地址时，该字段为`39`。

- **ptr**

  指针字段，从1开始计数，指向存放下一个IP地址的位置。初始值为4，每存入1个IP地址，ptr的值加4。ptr=40表示清单已满。

> **注意**，RFC 791指定路由器RR选项中记录的IP地址为**出口IP地址**。

我在内网测试了一下`ping -R`选项，发出的ICMP回显请求报文中确实带了RR选项，但返回的ICMP回显应答中没有RR的任何信息。说明目的主机不支持该选项。

# IP时间戳选项

IP时间戳选项要求路由器将收到数据报的时间戳填入IP头部。这个选项用处不大，但还是抄书列一下。

IP时间戳选项格式如下：

{%asset_img 7-7.jpg %}

- **code**

  时间戳选项代码为`0x44`。

- **len**

  选项总长度，一般为`36`或`40`。

- **ptr**

  与IP记录路由选项的`ptr`字段相同，指向下一个可用空间在指针。

- **OF**

  溢出字段，4bit的值。如果路由器因为没有空间而不能增加时间戳选项，那么它将增加溢出字段。

- **FL**

  4bit的值，表示标志字段。含义如下：

  {%asset_img 7-8.jpg %}

- **时间戳**

  时间戳的取值与ICMP时间戳请求与应答相同，即UTC时间从午夜开始计算的毫秒数。同样的，打开时间戳高位表示时间戳为非标准值。

  

------

# References

1. 《TCP/IP详解卷1：协议》

<!--天空-孙燕姿-->
{% meting "00399DqB09iNhA" "tencent" "song" "autoplay" "fixed" "volume: 0.3" "lrctype:0" %}


---
date: 2019-03-10 22:45:43
title: 《TCP-IP详解卷1》学习笔记(5)-ICMP协议
permalink: tcp-ip-volumn1-5
categories:
- 计算机
- 《TCP-IP详解卷1》
tags:
- 网络
- 读书笔记
---

因特网控制报文协议（ICMP，Internet Control Message Protocol）用于传递差错报文等控制信息。

<!--more-->

# ICMP报文格式

ICMP封装在IP数据报内部，报文格式如下：

{%asset_img 6-2.jpg %}

- **类型**和**代码**字段：ICMP报文有15种不同类型，同一类型通过代码字段细分。
- **检验和**：该字段是必须的，覆盖整个ICMP报文，算法与IP首部检验和相同。

# ICMP类型

不同类型的ICMP报文由**类型**和**代码**字段唯一标识，如下图：

{%asset_img 6-3.jpg %}

上图最后两列又把ICMP报文分为**查询报文**和**差错报文**，对这两种报文的处理方式不同。

## ICMP查询报文

### 地址掩码请求与应答

用于查询子网掩码。请求报文一般发往广播地址，而应答则是单播的。

{%asset_img 6-4.jpg %}

- **标识符**和**序列号**

  由发送端任意设定，应答报文中返回原值。这样发送方就可以把应答与请求进行匹配。

- **子网掩码**

  应答报文返回自己的子网掩码。

### 时间戳请求与应答

用于查询另一个系统的当前时间。

{%asset_img 6-6.jpg %}

- **发起时间戳**

  由请求端填写。标准时间戳一般是自午夜起计算的毫秒数，UTC时间。

- **接收时间戳**和**传送时间戳**

  由应答端填写。应答端收到请求报文时填写接收时间戳，发送应答时填写传送时间戳。实际上这两个字段一般设成相同值。

#### 调整时间

请求端可根据应答报文调整时间。

{%asset_img 6-7.jpg %}

1. **计算往返时间（RTT）**。RTT=收到应答时的时间-发送请求的时间。
2. **调整本机时间**。假设RTT一半用于请求报文的传输，一半用于应答报文的传输，那么 本机时间调整值=接收时间戳-发送时间戳-RTT/2。

另外，当系统返回一个非标准时间戳时（不是自午夜起计算的毫秒数，UTC时间），它将32bit时间戳的高位置1。此时不能计算时间差，因为单位不一致。

#### 其他获取时间日期的方法

- **daytime服务**（[RFC 867](https://www.ietf.org/rfc/rfc867.txt)）。返回自1900年1月1日起计算的秒数，UTC。
- **网络时间协议（NTP）**（[RFC 1305](https://www.ietf.org/rfc/rfc867.txt)）。精确调整一组系统的时钟，误差在毫秒级以内。
- **分布式时间服务（DTS）**。
- **守护程序timed(8)**。同步局域网内系统时钟，不在广域网内工作。

### 其他查询报文

后续章节会介绍其他ICMP查询报文。

## ICMP差错报文

ICMP差错报文始终包含产生该差错的IP数据报的首部和数据的前8字节，这样接受ICMP差错报文的模块就能把该差错对应到特定协议（IP首部的协议字段）和特定进程（IP数据的前8字节包含TCP/UDP端口号）。

以下情况不会产生ICMP差错报文：

1. ICMP差错报文
2. 目的IP地址是广播地址或多播地址
3. 目的链路层地址是广播地址
4. 不是IP分片的第一片
5. 源地址为零地址、环回地址、广播地址或多播地址（这些地址本就不该作为源地址出现在网络上）

### ICMP不可达差错

ICMP不可达差错报文的一般格式如下：

{%asset_img 6-10.jpg %}

- 第2个32bit必须为0。但是当**代码**字段为4时（“需要分片但设置了不分片比特”），路径MTU发现机制允许路由器把外出接口的MTU填入低16bit。
- ICMP规则允许返回多于8个字节的原差错IP数据报中的数据。但是大多数从伯克利派生出的系统只返回8字节。

# ICMP报文的处理

不同系统对ICMP报文的处理方式不同，下面给出4.4BSD系统对每个可能的ICMP报文的处理方法：

{%asset_img 6-12.jpg %}

------

# References

1. 《TCP/IP详解卷1：协议》

<!--Silent All These Years-孙燕姿-->
{% meting "003rGQse4RcMpr" "tencent" "song" "fixed" "volume: 0.3" "lrctype:0" %}

